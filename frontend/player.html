<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamMaster Pro - En Vivo</title>
    <link rel="stylesheet" href="style.css">
    <!-- FontAwesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div id="player-container">
        <!-- Live Badge -->
        <div class="live-indicator">
            <span class="dot"></span> EN VIVO
        </div>

        <!-- Home Button -->
        <a href="index.html" class="home-btn">
            <i class="fas fa-arrow-left"></i> Inicio
        </a>

        <!-- Video Element -->
        <video id="video-player" playsinline poster="assets/poster.jpg"></video>

        <!-- Overlay -->
        <div id="offline-overlay" class="overlay">
            <div class="overlay-content">
                <div class="pulse-ring"></div>
                <div class="status-icon">
                    <i class="fas fa-satellite-dish"></i>
                </div>
                <h2 id="status-title">Conectando...</h2>
                <p id="status-desc">Esperando se√±al del servidor...</p>

                <div class="reconnect-box" id="reconnect-box" style="display: none;">
                    <div class="loader"></div>
                    <span>Reintentando (<span id="attempt-count">0</span>/10)</span>
                </div>
            </div>
        </div>

        <!-- New Glass Controls -->
        <div class="controls-bar">
            <!-- Left Group -->
            <div class="controls-group">
                <button id="btn-toggle" class="control-btn big-btn" onclick="togglePlayback()">
                    <i class="fas fa-play" id="icon-toggle"></i>
                </button>

                <div class="volume-control">
                    <button class="control-btn" id="btn-mute" onclick="toggleMute()">
                        <i class="fas fa-volume-up" id="icon-volume"></i>
                    </button>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1">
                </div>
            </div>

            <!-- Right Group -->
            <div class="controls-group">
                <button class="control-btn" onclick="reloadStream()" title="Recargar se√±al">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="control-btn" onclick="toggleFullscreen()" title="Pantalla Completa">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js"></script>
    <script>
        // CONFIGURACI√ìN
        const server = window.location.hostname;
        const streamId = 'mistream';
        const hlsUrl = `http://${server}:8080/hls/${streamId}.m3u8`;

        // REFERENCIAS
        const video = document.getElementById('video-player');
        const overlay = document.getElementById('offline-overlay');
        const statusTitle = document.getElementById('status-title');
        const statusDesc = document.getElementById('status-desc');
        const reconnectBox = document.getElementById('reconnect-box');
        const attemptSpan = document.getElementById('attempt-count');

        // ICONOS
        const iconToggle = document.getElementById('icon-toggle');
        const iconVolume = document.getElementById('icon-volume');

        let hls = null;
        let isPlaying = false;
        let retryCount = 0;
        const MAX_RETRIES = 10;

        // Limpiar estado previo al cargar
        window.addEventListener('load', () => {
            stopStream();
            setTimeout(initPlayer, 100);
        });

        function initPlayer() {
            // Asegurar limpieza total antes de iniciar
            if (hls) {
                hls.destroy();
                hls = null;
            }

            statusTitle.textContent = "Conectando...";
            statusDesc.textContent = "Buscando se√±al de transmisi√≥n...";
            overlay.style.display = 'flex';
            reconnectBox.style.display = 'none';

            if (Hls.isSupported()) {
                hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 0, // No guardar buffer pasado para evitar loops de audio
                });

                hls.loadSource(hlsUrl);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    console.log('‚úÖ Stream encontrado');
                    retryCount = 0;
                    playVideo();
                });

                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.log('üåê Error de red...');
                                handleNetworkError();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.log('‚ö†Ô∏è Error de media, recuperando...');
                                hls.recoverMediaError();
                                break;
                            default:
                                showOffline();
                                break;
                        }
                    }
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari
                video.src = hlsUrl;
                video.addEventListener('loadedmetadata', () => {
                    playVideo();
                });
                video.addEventListener('error', handleNetworkError);
            }
        }

        function playVideo() {
            const playPromise = video.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    isPlaying = true;
                    updateUI(true);
                }).catch(e => {
                    console.log('Autoplay bloqueado');
                    statusTitle.textContent = "Listo para reproducir";
                    statusDesc.textContent = "Haz clic en Play para comenzar";
                    updateUI(false);
                });
            }
        }

        function togglePlayback() {
            if (video.paused) {
                if (!hls && !video.src) {
                    initPlayer();
                } else {
                    video.play();
                }
                isPlaying = true;
            } else {
                video.pause();
                isPlaying = false;
            }
            updateUI(isPlaying);
        }

        // Funci√≥n CR√çTICA para evitar audio duplicado
        function stopStream() {
            if (hls) {
                hls.stopLoad(); // Detener carga de red
                hls.detachMedia(); // Separar del video
                hls.destroy(); // Destruir instancia
                hls = null;
            }
            video.pause();
            video.removeAttribute('src'); // Quitar fuente
            video.load(); // Forzar al navegador a soltar el buffer
            isPlaying = false;
            updateUI(false);
        }

        function reloadStream() {
            stopStream();
            // Peque√±o delay para asegurar que el navegador limpie memoria
            setTimeout(initPlayer, 200);
        }

        function handleNetworkError() {
            if (retryCount < MAX_RETRIES) {
                retryCount++;
                attemptSpan.textContent = retryCount;
                reconnectBox.style.display = 'flex';
                statusTitle.textContent = "Se√±al perdida";
                statusDesc.textContent = "Intentando reconectar...";

                setTimeout(() => {
                    // Reintentar reiniciando completamente
                    if (hls) hls.startLoad();
                    else initPlayer();
                }, 2000);
            } else {
                showOffline();
            }
        }

        function showOffline(title = "Stream Offline", desc = "La transmisi√≥n no est√° activa en este momento.") {
            overlay.style.display = 'flex';
            statusTitle.textContent = title;
            statusDesc.textContent = desc;
            reconnectBox.style.display = 'none';
            isPlaying = false;
            updateUI(false);
        }

        function updateUI(playing) {
            if (playing) {
                overlay.style.display = 'none';
                iconToggle.className = 'fas fa-pause';
            } else {
                iconToggle.className = 'fas fa-play';
            }
        }

        // Volumen
        const volSlider = document.getElementById('volume-slider');
        volSlider.addEventListener('input', (e) => {
            video.volume = e.target.value;
            video.muted = false;
            updateVolIcon();
        });

        function toggleMute() {
            video.muted = !video.muted;
            updateVolIcon();
        }

        function updateVolIcon() {
            if (video.muted || video.volume === 0) iconVolume.className = 'fas fa-volume-mute';
            else if (video.volume < 0.5) iconVolume.className = 'fas fa-volume-down';
            else iconVolume.className = 'fas fa-volume-up';
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.getElementById('player-container').requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
    </script>
</body>

</html>