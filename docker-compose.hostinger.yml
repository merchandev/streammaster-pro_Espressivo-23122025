version: '3.8'

services:
  # Servidor RTMP principal con Nginx
  rtmp-server:
    build: ./nginx
    container_name: streammaster-rtmp
    restart: unless-stopped
    ports:
      - "1935:1935" # Puerto RTMP para encoders
      - "8080:80" # Puerto HTTP para HLS
    volumes:
      # Solo montar directorios, no archivos individuales
      - ./data/streams:/tmp/streams
      - ./logs/nginx:/var/log/nginx
    networks:
      - streamnet
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
    # El Dockerfile ya crea los directorios necesarios
    command: nginx -g 'daemon off;'

  # Servidor web simple para el player
  web:
    build:
      context: ./nginx
      dockerfile: Dockerfile.web
    container_name: streammaster-web
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./frontend:/usr/share/nginx/html:ro

    networks:
      - streamnet

networks:
  streamnet:
    driver: bridge
